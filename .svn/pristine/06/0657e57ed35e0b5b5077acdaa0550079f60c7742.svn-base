package info.zznet.znms.web.module.screen.controller;

import info.zznet.znms.base.bean.ZlogSystemStatus;
import info.zznet.znms.base.common.BaseController;
import info.zznet.znms.base.common.ZNMSLogger;
import info.zznet.znms.base.constants.PermissionConstants;
import info.zznet.znms.base.constants.SystemConstants;
import info.zznet.znms.base.dao.ExportLinkMapper;
import info.zznet.znms.base.entity.ApInformation;
import info.zznet.znms.base.entity.ExportLink;
import info.zznet.znms.base.job.ApInfomationJob;
import info.zznet.znms.base.rrd.bean.Graph;
import info.zznet.znms.base.rrd.bean.SubItem;
import info.zznet.znms.base.rrd.core.RrdFetcher;
import info.zznet.znms.base.rrd.exception.RrdQueryException;
import info.zznet.znms.base.util.EncryptionMD5;
import info.zznet.znms.base.util.HttpClientUtil;
import info.zznet.znms.web.WebRuntimeData;
import info.zznet.znms.web.annotation.CheckPermission;
import info.zznet.znms.web.module.screen.bean.ExportStreamInfo;
import info.zznet.znms.web.module.screen.bean.HeatData;
import info.zznet.znms.web.module.screen.bean.OnlineUserInfo;
import info.zznet.znms.web.module.screen.bean.UrlRanking;
import info.zznet.znms.web.module.system.bean.SystemOptionBean;
import info.zznet.znms.web.util.ApiClientUtil;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import java.io.IOException;
import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.concurrent.ConcurrentLinkedQueue;

/**
 * 首页大屏
 * Created by shenqilei on 2016/11/30.
 */
@Controller
@RequestMapping("/screen/module/index")
public class ScreenIndexController extends BaseController {

    @Autowired
    private ExportLinkMapper exportLinkMapper;

    private WebRuntimeData webRuntimeData = WebRuntimeData.instance;

    @RequestMapping({"","/"})
    @CheckPermission(PermissionConstants.P_SCREEN_VIEW)
    public ModelAndView init(){
        ModelAndView mav = new ModelAndView("/screen/module/index/index");

        mav.addObject("leftUp", getOnlineUserCount());
        try{
            mav.addObject("centerUp", JSONArray.fromObject(getHeatData(webRuntimeData.getSystemOptionBean().getSchoolBg())).toString());
        } catch(Exception e) {
            ZNMSLogger.error(e);
        }
        mav.addObject("rightUp", getNetHealthPoint());
        List<ExportStreamInfo> exportStreamInfoList = getExportStreamInfo();
        mav.addObject("leftDown", exportStreamInfoList);
        Map<String, Object> rightDownMap = getRightDownAreaData();
        mav.addObject("rightDown", rightDownMap);

        mav.addObject("mapImage", webRuntimeData.getSystemOptionBean().getSchoolBg());
        mav.addObject("logoImage", webRuntimeData.getSystemOptionBean().getIndexBg());
        mav.addObject("bgImage", webRuntimeData.getSystemOptionBean().getHomeBg());
        mav.addObject("apMaxUserCount", webRuntimeData.getSystemOptionBean().getApMaxUserCount());
        mav.addObject("heatMapRadius", webRuntimeData.getSystemOptionBean().getHeatMapRadius());

        return mav;
    }

    @RequestMapping(value = "/getLeftUpAreaData", method = RequestMethod.POST, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public OnlineUserInfo getLeftUpAreaData(){
        return getOnlineUserCount();
    }

    @RequestMapping(value = "/getRightUpAreaData", method = RequestMethod.POST, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public int getRightUpAreaData(){
        return getNetHealthPoint();
    }

    @RequestMapping(value = "/getCenterUpAreaData", method = RequestMethod.POST, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public List<HeatData> getCenterUpAreaData(){
        try {
            String mapImage =  new SystemOptionBean().getSchoolBg();
            return getHeatData(mapImage);
        } catch(Exception e) {
            ZNMSLogger.error(e);
            return new ArrayList<HeatData>();
        }
    }

    @RequestMapping(value = "/getRightDownAreaData", method = RequestMethod.POST, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public Map<String, Object> getRightDownAreaData() {
        Map<String, Object> map = new HashMap<String, Object>();
        map.put("urlRankingData", getUrlRanking());

        ConcurrentLinkedQueue<ZlogSystemStatus> zlogSystemStatusData = webRuntimeData.getZlogSystemStatusList();
        List<String> zlogSystemStatusXaxis = getXaxis(0, 5, 12, "yyyy-MM-dd HH:mm");
        map.put("systemStatusData", zlogSystemStatusData);
        map.put("systemStatusXaxis", zlogSystemStatusXaxis);

        List<Long> natLogCountData = webRuntimeData.getZlogNatlogCountList();
        List<Long> urlLogCountData = webRuntimeData.getZlogUrlLogCountList();
        List<String> zlogLogCountXaxis = new ArrayList<String>();
        for(int i=8;i>0;i--){
            zlogLogCountXaxis.add(i+"小时前");
        }
        List<Long> _natLogCountData = new ArrayList<Long>();
        List<Long> _urlLogCountData = new ArrayList<Long>();
        if(natLogCountData != null && urlLogCountData != null) {
            for(int i=7;i>=0;i--){
                _natLogCountData.add(natLogCountData.get(i));
                _urlLogCountData.add(urlLogCountData.get(i));
            }
        }

        map.put("natLogCountData", _natLogCountData);
        map.put("urlLogCountData", _urlLogCountData);
        map.put("logCountXaxis", zlogLogCountXaxis);

        return map;
    }

    @RequestMapping(value = "/getLeftDownAreaData", method = RequestMethod.POST, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public List<ExportStreamInfo> getLeftDownAreaData() {
        return getExportStreamInfo();
    }
    
    @RequestMapping(value = "/getFlowData", method = RequestMethod.POST, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public String getFlowData(){
    	try {
			HttpClientUtil httpClientUtil=new HttpClientUtil();
   
			Map<String,String> paramMap=new HashMap<String, String>();
			paramMap.put("size", "10");
			paramMap.put("needUserGroup", "1");
			paramMap.put("needTerminalType", "1");
			paramMap.put("needTimely", "1");
			String zlogIp=webRuntimeData.getSystemOptionBean().getZlogIp();
			String zlogPort=webRuntimeData.getSystemOptionBean().getZlogPort();
			
			/*ApiClientUtil apiClientUtil=new ApiClientUtil("http://"+zlogIp+":"+zlogPort+"/z-log/api/rest/getFlowData");
			String zlogresponse=apiClientUtil.post(paramMap);*/
			
			String zlogresponse="{\"wirelessFlow\":6.53,\"wireFlow\":4.98,\"wirelessFlowTrend\":{\"1481047200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 02:00\",\"timestamp\":1481047200000},\"1481043600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 01:00\",\"timestamp\":1481043600000},\"1481054400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 04:00\",\"timestamp\":1481054400000},\"1481097600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 16:00\",\"timestamp\":1481097600000},\"1481058000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 05:00\",\"timestamp\":1481058000000},\"1481072400000\":{\"count\":0,\"fCount\":0.38,\"time\":\"2016-12-07 09:00\",\"timestamp\":1481072400000},\"1481079600000\":{\"count\":0,\"fCount\":0.25,\"time\":\"2016-12-07 11:00\",\"timestamp\":1481079600000},\"1481061600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 06:00\",\"timestamp\":1481061600000},\"1481083200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 12:00\",\"timestamp\":1481083200000},\"1481104800000\":{\"count\":0,\"fCount\":0.08,\"time\":\"2016-12-07 18:00\",\"timestamp\":1481104800000},\"1481050800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 03:00\",\"timestamp\":1481050800000},\"1481040000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 00:00\",\"timestamp\":1481040000000},\"1481094000000\":{\"count\":0,\"fCount\":0.45,\"time\":\"2016-12-07 15:00\",\"timestamp\":1481094000000},\"1481068800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 08:00\",\"timestamp\":1481068800000},\"1481065200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 07:00\",\"timestamp\":1481065200000},\"1481076000000\":{\"count\":0,\"fCount\":5.1,\"time\":\"2016-12-07 10:00\",\"timestamp\":1481076000000},\"1481086800000\":{\"count\":0,\"fCount\":0.03,\"time\":\"2016-12-07 13:00\",\"timestamp\":1481086800000},\"1481101200000\":{\"count\":0,\"fCount\":0.24,\"time\":\"2016-12-07 17:00\",\"timestamp\":1481101200000},\"1481108400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 19:00\",\"timestamp\":1481108400000},\"1481090400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 14:00\",\"timestamp\":1481090400000}},\"userGroupFlow\":{\"root\":11.04,\"学生组\":0.47},\"pcFlowTrend\":{\"1481047200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 02:00\",\"timestamp\":1481047200000},\"1481043600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 01:00\",\"timestamp\":1481043600000},\"1481054400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 04:00\",\"timestamp\":1481054400000},\"1481097600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 16:00\",\"timestamp\":1481097600000},\"1481058000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 05:00\",\"timestamp\":1481058000000},\"1481072400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 09:00\",\"timestamp\":1481072400000},\"1481079600000\":{\"count\":0,\"fCount\":4.98,\"time\":\"2016-12-07 11:00\",\"timestamp\":1481079600000},\"1481061600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 06:00\",\"timestamp\":1481061600000},\"1481083200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 12:00\",\"timestamp\":1481083200000},\"1481104800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 18:00\",\"timestamp\":1481104800000},\"1481050800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 03:00\",\"timestamp\":1481050800000},\"1481040000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 00:00\",\"timestamp\":1481040000000},\"1481094000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 15:00\",\"timestamp\":1481094000000},\"1481068800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 08:00\",\"timestamp\":1481068800000},\"1481065200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 07:00\",\"timestamp\":1481065200000},\"1481076000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 10:00\",\"timestamp\":1481076000000},\"1481086800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 13:00\",\"timestamp\":1481086800000},\"1481101200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 17:00\",\"timestamp\":1481101200000},\"1481108400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 19:00\",\"timestamp\":1481108400000},\"1481090400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 14:00\",\"timestamp\":1481090400000}}}";
			
			//String zlogresponse=httpClientUtil.getPostResponse("http://"+zlogIp+":"+zlogPort+"/z-log/api/rest/getFlowData", paramMap);
			JSONObject zlogJsonObject=JSONObject.fromObject(zlogresponse);
			Map<String, Object> textMap = new HashMap<String, Object>();
			
			textMap.put("wirelessFlowTrend", zlogJsonObject.get("wirelessFlowTrend"));
			textMap.put("pcFlowTrend", zlogJsonObject.get("pcFlowTrend"));
			
			textMap.put("wireFlow", zlogJsonObject.get("wirelessFlow"));
			textMap.put("wirelessFlow", zlogJsonObject.get("wireFlow"));
			//JSONObject userGroupFlow=JSONObject.fromObject(zlogJsonObject.get("userGroupCount"));
			//textMap.put("userGroupFlow", userGroupFlow);
			
			
			JSONObject wirelessFlowTrend=JSONObject.fromObject(zlogJsonObject.get("wirelessFlowTrend"));
			Iterator wirelessFlowIt=wirelessFlowTrend.keys();
			List<Map.Entry<String,String>> wirelessFlowList = null; 
			Map<String,String> map=new TreeMap<String, String>();
			while(wirelessFlowIt.hasNext()){
				String key=(String)wirelessFlowIt.next();
				String value=wirelessFlowTrend.getString(key);
				JSONObject datas=JSONObject.fromObject(value);
				map.put(datas.getString("time"), datas.getString("fCount"));
			}
 
			wirelessFlowList = new ArrayList<Map.Entry<String,String>>(map.entrySet()); 

			Collections.sort(wirelessFlowList, new Comparator<Map.Entry<String,String>>(){ 
			public int compare(Map.Entry<String,String> mapping1,Map.Entry<String,String> mapping2){ 
			   return mapping1.getKey().compareTo(mapping2.getKey()); 
			  } 
			}); 
			
			JSONObject pcFlowTrend=JSONObject.fromObject(zlogJsonObject.get("pcFlowTrend"));
			Iterator pcFlowIt=pcFlowTrend.keys();
			List<Map.Entry<String,String>> pcFlowList = null; 
			Map<String,String> pcMap=new TreeMap<String, String>();
			while(pcFlowIt.hasNext()){
				String key=(String)pcFlowIt.next();
				String value=pcFlowTrend.getString(key);
				JSONObject datas=JSONObject.fromObject(value);
				pcMap.put(datas.getString("time"), datas.getString("fCount"));
			}
			
			pcFlowList = new ArrayList<Map.Entry<String,String>>(pcMap.entrySet()); 
			
			Collections.sort(pcFlowList, new Comparator<Map.Entry<String,String>>(){ 
			public int compare(Map.Entry<String,String> mapping1,Map.Entry<String,String> mapping2){ 
			   return mapping1.getKey().compareTo(mapping2.getKey()); 
			  } 
			}); 
			
			textMap.put("wirelessFlowTrend", JSONArray.fromObject(wirelessFlowList));
			textMap.put("pcFlowTrend", JSONArray.fromObject(pcFlowList));
			
			textMap.put("wireFlow", zlogJsonObject.get("wirelessFlow"));
			textMap.put("wirelessFlow", zlogJsonObject.get("wireFlow"));
			
			int flowCount=zlogJsonObject.getInt("wirelessFlow")+zlogJsonObject.getInt("wireFlow");
			textMap.put("flowCount", flowCount);
			
			JSONObject userGroupFlow=JSONObject.fromObject(zlogJsonObject.get("userGroupFlow"));
			textMap.put("userGroupFlow", userGroupFlow);
			
			textMap.put("timeAxis", JSONArray.fromObject(getTimesnight()));
			
			double userGroupFlowCount=0;
			Iterator userGroupIterator = userGroupFlow.keys();
			while (userGroupIterator.hasNext()) {
			  String key = (String) userGroupIterator.next();
			  double value = userGroupFlow.getDouble(key); 
			  userGroupFlowCount+=value;
			}
			textMap.put("userGroupFlowCount", userGroupFlowCount);
			return JSONArray.fromObject(textMap).toString();
		} catch (Exception e) {
			ZNMSLogger.error("Failed to get data from zos,"+e.getMessage());
		}
    	return null;
    }
    
    
    private Map<String, Object> getUrlRanking(){
        List<UrlRanking> urlRankingList = webRuntimeData.getUrlRankingList();
        List<UrlRanking> _urlRankingList = new ArrayList<UrlRanking>();
        long total = 0l;
        if(urlRankingList != null) {
            int i=0;
            for(UrlRanking urlRanking : urlRankingList) {
                if(i>=5){
                    break;
                }
                total += urlRanking.getCount();
                _urlRankingList.add(urlRanking);
                i++;
            }
        }
        Map<String, Object> retVal = new HashMap<String, Object>();
        retVal.put("urlRankingList", _urlRankingList);
        retVal.put("total", total);
        return retVal;
    }

    /**
     * 获取网络健康指数
     * @return
     */
    private int getNetHealthPoint(){
        return webRuntimeData.getNetworkHealth();
    }

    /**
     * 获取在线数
     * @return
     */
    private OnlineUserInfo getOnlineUserCount(){
        return webRuntimeData.getOnlineUserInfo();
    }

    private List<HeatData> getHeatData(String mapFileName){
        ZNMSLogger.debug("begin get heat data");
        List<HeatData> list = new ArrayList<HeatData>();
        Map<String, ApInformation> apInfoMap = ApInfomationJob.apInfomationMap;
        ZNMSLogger.debug("apMap size:"+apInfoMap.size());
        if(apInfoMap != null) {

            for(String key : apInfoMap.keySet()) {
                ApInformation apInfo = apInfoMap.get(key);
                String axis = apInfo.getApAxis();
                //ZNMSLogger.debug("ap:"+apInfo.getApMac()+",axis:"+axis);
                if(!StringUtils.contains(axis, ",")) {
                    continue;
                }
                BigDecimal absoluteX = new BigDecimal(axis.split(",")[0]);
                BigDecimal absoluteY = new BigDecimal(axis.split(",")[1]);
                //ZNMSLogger.debug("absoluteX:"+absoluteX+", absoluteY:"+absoluteY);
				/*BigDecimal x = absoluteX.divide(new BigDecimal(width), 8, BigDecimal.ROUND_HALF_UP);
				BigDecimal y = absoluteY.divide(new BigDecimal(height), 8, BigDecimal.ROUND_HALF_UP);*/

                BigDecimal x = absoluteX;
                BigDecimal y = absoluteY;
                HeatData heatData = new HeatData();
                heatData.setValue(new BigDecimal(apInfo.getApUserCount()));
                heatData.setX(x);
                heatData.setY(y);
                //ZNMSLogger.debug("heat data:("+x+","+y+")"+heatData.getValue());
                if(x.compareTo(BigDecimal.ONE)>0) {
                    //ZNMSLogger.warn("heat data x value larger than 1" + x);
                }
                if(y.compareTo(BigDecimal.ONE)>0) {
                    //ZNMSLogger.warn("heat data y value larger than 1" + y);
                }
                list.add(heatData);
            }
        }
        return list;
    }

    /**
     * 获取出口流量信息
     * @return
     */
    private List<ExportStreamInfo> getExportStreamInfo(){
        List<ExportStreamInfo> exportStreamInfoList = new ArrayList<ExportStreamInfo>();

        List<ExportLink> exportLinkList = exportLinkMapper.findLatestThree();
        if(exportLinkList == null) {
            return exportStreamInfoList;
        }

        Calendar now = Calendar.getInstance();
        Calendar oneHourAgo = Calendar.getInstance();
        now.set(Calendar.SECOND, 0);
        now.set(Calendar.MILLISECOND, 0);
        oneHourAgo.set(Calendar.SECOND, 0);
        oneHourAgo.set(Calendar.MILLISECOND, 0);
        oneHourAgo.add(Calendar.MINUTE, -60);

        for(ExportLink exportLink : exportLinkList){
            try {
                Graph graph = RrdFetcher.fetchDataAndConvertToGraph(
                        SystemConstants.TEMPLATE_NAME_NET_STREAM,
                        exportLink.getGraphUuid(), oneHourAgo.getTimeInMillis(),
                        now.getTimeInMillis());
                if(graph == null) {
                    continue;
                }
                ExportStreamInfo exportStreamInfo = new ExportStreamInfo();
                exportStreamInfo.setDivId(EncryptionMD5.getMD5(exportLink.getExportLinkDescription()));
                exportStreamInfo.setGraph(graph);
                exportStreamInfo.setName(exportLink.getExportLinkDescription());
                exportStreamInfo.setMaxBandWidth(exportLink.getMaxBandWidth());
                List<SubItem> subItems = graph.getData();
                if(subItems == null) {
                    exportStreamInfo.setUpStream(0d);
                    exportStreamInfo.setDownStream(0d);
                } else {
                    SubItem upStream = subItems.get(0);
                    List<String> data = upStream.getData();
                    if(data == null) {
                        exportStreamInfo.setUpStream(0d);
                    } else {
                        exportStreamInfo.setUpStream(Double.parseDouble(data.get(data.size() - 1)));
                    }
                    SubItem downStream = subItems.get(1);
                    data = downStream.getData();
                    if(data == null) {
                        exportStreamInfo.setDownStream(0d);
                    } else {
                        exportStreamInfo.setDownStream(Double.parseDouble(data.get(data.size() - 1)));
                    }
                }

                exportStreamInfoList.add(exportStreamInfo);
            } catch (RrdQueryException e) {
                ZNMSLogger.error(e);
                continue;
            }
        }
        return exportStreamInfoList;
    }

    /**
     * 获取时间轴
     * @param offset 起始偏移量
     * @param seperate 间隔（分钟）
     * @param total 总数
     * @param format 格式
     * @return
     */
    private List<String> getXaxis(int offset, int seperate, int total, String format){
        List<String> xAxisList = new ArrayList<>();
        Calendar calendar = Calendar.getInstance();
        SimpleDateFormat sdf = new SimpleDateFormat(format);
        calendar.set(Calendar.MILLISECOND, 0);
        calendar.set(Calendar.SECOND, 0);
        calendar.add(Calendar.MINUTE, (-seperate * total) + (-offset * seperate));
        for(int i = 0;i<total;i++){
            calendar.add(Calendar.MINUTE, seperate);
            xAxisList.add(sdf.format(calendar.getTime()));
        }
        return xAxisList;
    }
    
    public static void main(String[] args) {
    	String str="{\"wirelessFlow\":6.53,\"wireFlow\":4.98,\"wirelessFlowTrend\":{\"1481047200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 02:00\",\"timestamp\":1481047200000},\"1481043600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 01:00\",\"timestamp\":1481043600000},\"1481054400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 04:00\",\"timestamp\":1481054400000},\"1481097600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 16:00\",\"timestamp\":1481097600000},\"1481058000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 05:00\",\"timestamp\":1481058000000},\"1481072400000\":{\"count\":0,\"fCount\":0.38,\"time\":\"2016-12-07 09:00\",\"timestamp\":1481072400000},\"1481079600000\":{\"count\":0,\"fCount\":0.25,\"time\":\"2016-12-07 11:00\",\"timestamp\":1481079600000},\"1481061600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 06:00\",\"timestamp\":1481061600000},\"1481083200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 12:00\",\"timestamp\":1481083200000},\"1481104800000\":{\"count\":0,\"fCount\":0.08,\"time\":\"2016-12-07 18:00\",\"timestamp\":1481104800000},\"1481050800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 03:00\",\"timestamp\":1481050800000},\"1481040000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 00:00\",\"timestamp\":1481040000000},\"1481094000000\":{\"count\":0,\"fCount\":0.45,\"time\":\"2016-12-07 15:00\",\"timestamp\":1481094000000},\"1481068800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 08:00\",\"timestamp\":1481068800000},\"1481065200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 07:00\",\"timestamp\":1481065200000},\"1481076000000\":{\"count\":0,\"fCount\":5.1,\"time\":\"2016-12-07 10:00\",\"timestamp\":1481076000000},\"1481086800000\":{\"count\":0,\"fCount\":0.03,\"time\":\"2016-12-07 13:00\",\"timestamp\":1481086800000},\"1481101200000\":{\"count\":0,\"fCount\":0.24,\"time\":\"2016-12-07 17:00\",\"timestamp\":1481101200000},\"1481108400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 19:00\",\"timestamp\":1481108400000},\"1481090400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 14:00\",\"timestamp\":1481090400000}},\"userGroupFlow\":{\"root\":11.04,\"学生组\":0.47},\"pcFlowTrend\":{\"1481047200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 02:00\",\"timestamp\":1481047200000},\"1481043600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 01:00\",\"timestamp\":1481043600000},\"1481054400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 04:00\",\"timestamp\":1481054400000},\"1481097600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 16:00\",\"timestamp\":1481097600000},\"1481058000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 05:00\",\"timestamp\":1481058000000},\"1481072400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 09:00\",\"timestamp\":1481072400000},\"1481079600000\":{\"count\":0,\"fCount\":4.98,\"time\":\"2016-12-07 11:00\",\"timestamp\":1481079600000},\"1481061600000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 06:00\",\"timestamp\":1481061600000},\"1481083200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 12:00\",\"timestamp\":1481083200000},\"1481104800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 18:00\",\"timestamp\":1481104800000},\"1481050800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 03:00\",\"timestamp\":1481050800000},\"1481040000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 00:00\",\"timestamp\":1481040000000},\"1481094000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 15:00\",\"timestamp\":1481094000000},\"1481068800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 08:00\",\"timestamp\":1481068800000},\"1481065200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 07:00\",\"timestamp\":1481065200000},\"1481076000000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 10:00\",\"timestamp\":1481076000000},\"1481086800000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 13:00\",\"timestamp\":1481086800000},\"1481101200000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 17:00\",\"timestamp\":1481101200000},\"1481108400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 19:00\",\"timestamp\":1481108400000},\"1481090400000\":{\"count\":0,\"fCount\":0,\"time\":\"2016-12-07 14:00\",\"timestamp\":1481090400000}}}";
    	JSONObject zlogJsonObject=JSONObject.fromObject(str);
    	Map<String, Object> textMap = new HashMap<String, Object>();
    	JSONObject wirelessFlowTrend=JSONObject.fromObject(zlogJsonObject.get("wirelessFlowTrend"));
    	Iterator wirelessFlowIt=wirelessFlowTrend.keys();
    	List<Map.Entry<String,String>> mappingList = null; 
    	Map<String,String> map=new TreeMap<String, String>();
    	while(wirelessFlowIt.hasNext()){
    		String key=(String)wirelessFlowIt.next();
    		String value=wirelessFlowTrend.getString(key);
    		JSONObject datas=JSONObject.fromObject(value);
    		map.put(datas.getString("time"), datas.getString("fCount"));
    		//map.put(key, value);
    		//System.out.println(key +" : "+value);
    	}
    	//通过ArrayList构造函数把map.entrySet()转换成list 
    	mappingList = new ArrayList<Map.Entry<String,String>>(map.entrySet()); 
        //通过比较器实现比较排序 
    	Collections.sort(mappingList, new Comparator<Map.Entry<String,String>>(){ 
    	public int compare(Map.Entry<String,String> mapping1,Map.Entry<String,String> mapping2){ 
    	   return mapping1.getKey().compareTo(mapping2.getKey()); 
    	  } 
    	}); 
    	System.out.println(JSONArray.fromObject(mappingList));
    	/*for(Map.Entry<String,String> mapping:mappingList){ 
    	   System.out.println(mapping.getKey()+" : "+mapping.getValue());
    	 } */
    	textMap.put("wirelessFlowTrend", JSONArray.fromObject(mappingList));
    	
    	
    	JSONObject pcFlowTrend=JSONObject.fromObject(zlogJsonObject.get("pcFlowTrend"));
    	Iterator pcFlowIt=pcFlowTrend.keys();
    	List<Map.Entry<String,String>> pcFlowList = null; 
    	Map<String,String> pcMap=new TreeMap<String, String>();
    	while(pcFlowIt.hasNext()){
    		String key=(String)pcFlowIt.next();
    		String value=pcFlowTrend.getString(key);
    		JSONObject datas=JSONObject.fromObject(value);
    		pcMap.put(datas.getString("time"), datas.getString("fCount"));
    	}
    	//通过ArrayList构造函数把map.entrySet()转换成list 
    	pcFlowList = new ArrayList<Map.Entry<String,String>>(pcMap.entrySet()); 
        //通过比较器实现比较排序 
    	Collections.sort(pcFlowList, new Comparator<Map.Entry<String,String>>(){ 
    	public int compare(Map.Entry<String,String> mapping1,Map.Entry<String,String> mapping2){ 
    	   return mapping1.getKey().compareTo(mapping2.getKey()); 
    	  } 
    	}); 
    	System.out.println(JSONArray.fromObject(pcFlowList));
    	
    	textMap.put("pcFlowTrend", JSONArray.fromObject(pcFlowList));
    	
    	textMap.put("wireFlow", zlogJsonObject.get("wirelessFlow"));
    	textMap.put("wirelessFlow", zlogJsonObject.get("wireFlow"));
    	JSONObject userGroupFlow=JSONObject.fromObject(zlogJsonObject.get("userGroupFlow"));
    	textMap.put("userGroupFlow", userGroupFlow);
    	System.out.println(textMap);
    	
    	double userGroupFlowCount=0;
    	Iterator it = userGroupFlow.keys();
        while (it.hasNext()) {
          String key = (String) it.next();
          double value = userGroupFlow.getDouble(key); //类型强转失败会异常
          userGroupFlowCount+=value;
          //System.out.println(key + " : " +value);
        }
        System.out.println(userGroupFlowCount);
    	//System.out.println(JSONArray.fromObject(getTimesnight()));
	}
    
    public static List getTimesnight(){
    	List list=new ArrayList();
    	SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM-dd HH:mm");
    	for (int i = 0; i <= 23; i++) {
	    	Calendar cal = Calendar.getInstance(); 
	    	cal.set(Calendar.HOUR_OF_DAY, i); 
	    	cal.set(Calendar.SECOND, 0); 
	    	cal.set(Calendar.MINUTE, 0); 
	    	cal.set(Calendar.MILLISECOND, 0); 
	    	list.add(sdf.format(cal.getTimeInMillis()));
    	}
    	return list; 
    } 
}
