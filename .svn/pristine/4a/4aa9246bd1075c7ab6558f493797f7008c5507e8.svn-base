package info.zznet.znms.web.module.screen.controller;

import info.zznet.znms.base.bean.ZlogSystemStatus;
import info.zznet.znms.base.common.BaseController;
import info.zznet.znms.base.common.ZNMSLogger;
import info.zznet.znms.base.constants.PermissionConstants;
import info.zznet.znms.base.constants.SystemConstants;
import info.zznet.znms.base.dao.ApInformationMapper;
import info.zznet.znms.base.dao.ExportLinkMapper;
import info.zznet.znms.base.entity.ApInformation;
import info.zznet.znms.base.entity.ExportLink;
import info.zznet.znms.base.entity.Screen;
import info.zznet.znms.base.job.ApInfomationJob;
import info.zznet.znms.base.rrd.bean.Graph;
import info.zznet.znms.base.rrd.bean.SubItem;
import info.zznet.znms.base.rrd.core.RrdFetcher;
import info.zznet.znms.base.rrd.exception.RrdQueryException;
import info.zznet.znms.base.util.EncryptionMD5;
import info.zznet.znms.web.WebRuntimeData;
import info.zznet.znms.web.annotation.CheckPermission;
import info.zznet.znms.web.module.screen.bean.ExportStreamInfo;
import info.zznet.znms.web.module.screen.bean.HeatData;
import info.zznet.znms.web.module.screen.bean.OnlineUserInfo;
import info.zznet.znms.web.module.screen.bean.UrlRanking;
import info.zznet.znms.web.module.screen.service.ScreenService;
import info.zznet.znms.web.module.system.bean.SystemOptionBean;
import info.zznet.znms.web.util.ConfigUtil;
import net.sf.json.JSONArray;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.concurrent.ConcurrentLinkedQueue;

@Controller
@RequestMapping("/screen")
public class ScreenController extends BaseController{
	private static final String VIEW = "/screen/screen";

	@Autowired
	private ScreenService screenService;

	private WebRuntimeData webRuntimeData = WebRuntimeData.instance;
	
	
	@RequestMapping({"","/"})
	@CheckPermission(PermissionConstants.P_SCREEN_VIEW)
	public ModelAndView init(){
		SystemOptionBean config = webRuntimeData.getSystemOptionBean();
		ModelAndView mav = new ModelAndView(VIEW);

		List<Screen> screens = screenService.findAll();

		mav.addObject(screens);
		mav.addObject("logoImage", config.getIndexBg());
		mav.addObject("bgImage", config.getHomeBg());
		mav.addObject("logoHeight",getScreenLogoSize()[1]);


		return mav;
	}

	private Integer[] getScreenLogoSize(){
		Integer[] result = new Integer[2];
		BufferedImage bufferedImage = null;
		try {
			File imageFile = new File(ConfigUtil.getString("znms.image.path") + WebRuntimeData.instance.getSystemOptionBean().getIndexBg());
			if(!imageFile.exists() || !imageFile.isFile()) {
				return result;
			}
			imageFile.lastModified();
			bufferedImage = ImageIO.read(imageFile);
		} catch (IOException e) {
			ZNMSLogger.error(e);
			return result;
		}
		result[0] = bufferedImage.getWidth();
		result[1] = bufferedImage.getHeight();
		return result;
	}
}
