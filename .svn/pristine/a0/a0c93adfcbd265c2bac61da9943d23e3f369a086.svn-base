package info.zznet.znms.base.job;

import info.zznet.znms.base.common.ZNMSLogger;
import info.zznet.znms.base.dao.SystemLogMapper;
import info.zznet.znms.base.dao.ThresholdValueTriggerLogMapper;
import info.zznet.znms.base.util.DateUtil;
import info.zznet.znms.web.WebRuntimeData;
import info.zznet.znms.web.module.system.bean.SystemOptionBean;

import java.text.SimpleDateFormat;
import java.util.Date;

import org.apache.commons.lang.StringUtils;
import org.quartz.DisallowConcurrentExecution;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

/**
 * db维护任务
 * @author dell001
 *
 */
@Service
@DisallowConcurrentExecution
public class DbMaintainJob {
	private SystemOptionBean systemConfig = WebRuntimeData.instance.getSystemOptionBean();
	@Autowired
	private SystemLogMapper syslogMapper;
	@Autowired
	private ThresholdValueTriggerLogMapper tvtlogMapper;
	
	@Scheduled(cron = "0 0 0 * * ?")
//	@Scheduled(fixedDelay=1000)
	public void deleteSystemLogWhenOverSize(){
		long count = syslogMapper.getCount(null);
		if(count > systemConfig.getLogRemainNumber()) {
			long deleteNumber = count - systemConfig.getLogRemainNumber();
			ZNMSLogger.info("delete "+syslogMapper.deleteOldLog(deleteNumber)+" old syslog for over size");
		}
	}
	
	@Scheduled(cron = "0 0 0 * * ?")
//	@Scheduled(fixedDelay=1000)
	public void deleteSystemLogWhenExpired(){
		String expiredTimeStr = systemConfig.getLogRemainTime();
		long expiredTime = 60 * 60 * 24 * 7l;
		if(StringUtils.containsIgnoreCase(expiredTimeStr, "周")) {
			expiredTime = Long.parseLong(StringUtils.remove(expiredTimeStr, "周"));
			expiredTime *= 60 * 60 * 24 * 7l;
		} else if(StringUtils.containsIgnoreCase(expiredTimeStr, "天")) {
			expiredTime = Long.parseLong(StringUtils.remove(expiredTimeStr, "天"));
			expiredTime *= 60 * 60 * 24l;
		} else if(StringUtils.containsIgnoreCase(expiredTimeStr, "月")){
			expiredTime = Long.parseLong(StringUtils.remove(expiredTimeStr, "月"));
			expiredTime *= 60 * 60 * 24 * 31l;
		} else if(StringUtils.containsIgnoreCase(expiredTimeStr, "年")){
			expiredTime = Long.parseLong(StringUtils.remove(expiredTimeStr, "年"));
			expiredTime *= 60 * 60 * 24 * 366l;
		} else {
			expiredTime *= 60 * 60 * 24l;
		}
		Date today = DateUtil.getDayStart(new Date());
		Date expireDate = new Date(today.getTime() - expiredTime * 1000);
		long deleted = syslogMapper.deleteExpiredLog(expireDate);
		ZNMSLogger.info("delete "+deleted+" expired syslog before " +new SimpleDateFormat("yyyyMMdd").format(expireDate));
	}
	
	@Scheduled(cron = "0 0 0 * * ?")
//	@Scheduled(fixedDelay=1000)
	public void deleteThresholdLogWhenExpired(){
		long expireTime = systemConfig.getRemainDays() * 60 * 60 * 24 * 1000l;
		Date today = DateUtil.getDayStart(new Date());
		Date expireDate = new Date(today.getTime() - Math.abs(expireTime));
		long deleted = tvtlogMapper.deleteExpiredLog(expireDate);
		ZNMSLogger.info("delete "+deleted+" expired tvtlog before " +new SimpleDateFormat("yyyyMMdd").format(expireDate));
	}
	
	@Scheduled(cron = "0 0 0 * * ?")
//	@Scheduled(fixedDelay=1000)
	public void doPartition(){
		try {
			syslogMapper.doPartitionByMonth("SYSTEM_LOG");
			ZNMSLogger.error("系统日志表分区成功");
		} catch (Throwable e) {
			ZNMSLogger.error(e);
		}
	}
}
