<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<!doctype html>
<html>
<head>
<%
	String path=request.getContextPath();
%>
<meta charset="utf-8">
<meta name=”viewport” content=”width=device-width, initial-scale=1,
	height=device-width″ />
<meta name="renderer" content="webkit">
<title>卓智运维管理系统</title>

<!-- jquery 主文件 -->
<script src="<%=path %>/js/jquery-1.10.2.min.js"></script>

<script type="text/javascript">

function getScreenCss(){
	//判断显示器分辨率
	var winWidth  = window.screen.width;
	var winHeight = window.screen.height;
	var href = "<%=path%>/css/znms_style_show_"+winWidth+"_"+winHeight+".css";
	return href;
}

$("<link>").attr({ rel: "stylesheet",
    id: "screen_css", 
 	type: "text/css",
     href: getScreenCss()
 }).appendTo($("head"));
</script>
<link id="main_css" href="<%=path%>/css/znms_style.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="<%=path %>/js/heatmap.min.js"></script>
<script type="text/javascript" src="<%=path %>/js/echart/echarts.js"></script>
<script type="text/javascript" src="<%=path %>/js/ejChart/ej.web.all.min.js"></script>
<script type="text/javascript" src="<%=path %>/js/ejChart/properties.js"></script>
<script type="text/javascript" src="<%=path %>/js/screen.js"></script>

<style type="text/css">
.doughnut_container {
	position: relative;
	height: 163px;
}
.doughnut_container svg {
	position: absolute;
	left: 10%;
	top: -18%;
}
#url_ranking {
	position: relative;
}
#url_ranking svg {
	position: absolute;
	left: 5px;
	top: -75px
}
#left_down {
	width: 57.3%;
	height: 100%;
 	display: inline-block;
}
.zlog_data_list>li {
	margin-bottom: 15px;
	margin-top: 15px;
}
.heatmap-canvas {
	width: 100%;
	height: 100%;
}
#full_screen{
	padding:0;
	margin:0;
	height:100%;
	width:100%;
	display:none;
}
.screen_grid{
	display:table;
	width:100%;
}
.screen_grid >div{
	display:table-row;
}
.screen_grid > div >div{
	width:50%;
	height: 500px;
	display:table-cell;
    padding: 15px;
    border-radius: 5px;
    position: relative;
}
.screen_grid > div >div >div{
    box-shadow: 1px 1px 1px 1px #b4cadf;
    background: url(<%=path%>/images/bg_img.png) repeat;
	height:470px;
}
.R{
	margin: 10px 10px 0 0;
	cursor:pointer;
}
</style>

<script type="text/javascript">	
	
	
	var rightDownPieFill = ["rgb(51, 204, 204)","rgb(51, 153, 0)","rgb(255, 153, 0)","rgb(204, 0, 51)","rgb(255, 102, 0)","rgb(102, 102, 153)","rgb(0, 153, 255)","rgb(255, 153, 51)","rgb(255, 34, 0)","rgb(0, 204, 0)"];
	var registerUserCircle;
	var activeUserCircle;
	var freeUserCircle;
	var lostUserCircle;
	
	var centerUpHeatMap;
	
	var refresher1;
	var refresher2;
	
	$(document).ready(function(){
		document.addEventListener("fullscreenchange", function(e) {
			if(document.fullScreenElement!=null && !document.fullScreenElement) {
				hideFullScreen();
				document.exitFullScreen;
			}
		});
		document.addEventListener("mozfullscreenchange", function(e) {
			if(!document.mozFullScreen) {
				hideFullScreen();
				document.mozCancelFullScreen();
			}
		});
		document.addEventListener("webkitfullscreenchange", function(e) {
			if(!document.webkitIsFullScreen) {
				hideFullScreen();
				document.webkitCancelFullScreen();
			}			
		});
		document.addEventListener("msfullscreenchange", function(e) {
			if(!document.msFullScreenElement) {
				hideFullScreen();
				document.msExitFullscreen();
			}
		});
		hideFullScreen();
	});

	function showFullScreen(){
		$("#screen_css").attr("href", getScreenCss());
		$("#main_css").attr("href", "<%=path%>/css/blank.css");
		$("#full_screen").siblings("div").hide();
		
		registerUserCircle = drawLeftUpCircle("registerUserCount", "#06c", "1", "${leftUp.registerUserCount}");
		activeUserCircle = drawLeftUpCircle("activeUserCount", "#39c", "${leftUp.activeUserCount/leftUp.registerUserCount}", "${leftUp.activeUserCount}");
		freeUserCircle = drawLeftUpCircle("freeUserCount", "#3c3", "${leftUp.freeUserCount/leftUp.registerUserCount}", "${leftUp.freeUserCount}");
		lostUserCircle = drawLeftUpCircle("lostUserCount", "#f93", "${leftUp.lostUserCount/leftUp.registerUserCount}", "${leftUp.lostUserCount}");

		var centerUpData = '${centerUp}';
		eval("var centerUpData="+centerUpData);
		centerUpHeatMap = drawHeatGraph("heat_map", centerUpData, centerUpHeatMap);
		
		var leftDownJson = '${leftDownJson}';
		eval("var leftDownJson=" + leftDownJson);
		if(leftDownJson != null) {
			for(var i=0;i<leftDownJson.length;i++) {
				var exportStreamInfo = leftDownJson[i];
				var percent = (exportStreamInfo.downStream * 100)/exportStreamInfo.maxBandWidth;
				drawLeftDownCircle(exportStreamInfo.divId, percent);
				drawLeftDownChart(exportStreamInfo.divId, exportStreamInfo.graph);
			}
		}
		
		var rightDownData = '${rightDownJson}';
		eval('var rightDownData='+rightDownData);
		drawRightDownPie("url_ranking", rightDownData.urlRankingData);
		drawRightDownSystemStatusChart("zlog_cpu", "cpu", rightDownData.systemStatusData, rightDownData.systemStatusXaxis);
		drawRightDownSystemStatusChart("zlog_mem", "mem", rightDownData.systemStatusData, rightDownData.systemStatusXaxis);
		drawRightDownLogCountChart("zlog_log_count", rightDownData);
				
		refresher1 = setInterval(function(){
			refreshLeftUpData();
			refreshCenterUpData();
			refreshRightUpData();
			refreshLeftDownData();
		}, 60000);
		refresher2 = setInterval(function(){
			refreshRightDownData();
		}, 300000);
		
		$("#full_screen").show();
		
		var docElm = document.documentElement;
		//W3C 
		if (docElm.requestFullscreen) { 
		  docElm.requestFullscreen(); 
		}
		//FireFox 
		else if (docElm.mozRequestFullScreen) { 
		  docElm.mozRequestFullScreen(); 
		}
		//Chrome等 
		else if (docElm.webkitRequestFullScreen) { 
		  docElm.webkitRequestFullScreen(); 
		}
		//IE11
		else if (elem.msRequestFullscreen) {
		 elem.msRequestFullscreen();
		}
	}
	
	function hideFullScreen(){
		if(refresher1 != null) {
			clearInterval(refresher1);
			refresher1 = null;
		}
		if(refresher2 != null) {
			clearInterval(refresher2);
			refresher2 = null;
		}
		$("#screen_css").attr("href", "<%=path%>/css/blank.css");
		$("#main_css").attr("href", "<%=path%>/css/znms_style.css");
		$("#full_screen").hide();
		$("#full_screen").siblings("div").show();
	}
	
	function refreshLeftUpData(){
		$.ajax({
			type:'POST',
			url:'<%=path%>/screen/getLeftUpAreaData',
			success:function(data){
				var total = data.registerUserCount;
				drawLeftUpCircle("registerUserCount", "#06c", "1", total);
				drawLeftUpCircle("activeUserCount", "#39c", data.activeUserCount/total, data.activeUserCount);
				drawLeftUpCircle("freeUserCount", "#3c3", data.freeUserCount/total, data.freeUserCount);
				drawLeftUpCircle("lostUserCount", "#f93", data.lostUserCount/total, data.lostUserCount);
				odoo.default({ el:'.js-odoo',value:data.totalOnlineUserCount });
				$("#wireless_count").text((data.wirelessUserCount * 100/data.totalOnlineUserCount)+"%");
				$("#wire_count").text((data.wireUserCount * 100/data.totalOnlineUserCount)+"%");
				$("#etc_count").text((data.etcUserCount * 100/data.totalOnlineUserCount)+"%");
			}
		});
	}
	
	function refreshCenterUpData(){
		$.ajax({
			type:'POST',
			url:'<%=path%>/screen/getCenterUpAreaData',
			success:function(data){
				centerUpHeatMap = drawHeatGraph("heat_map", data, centerUpHeatMap);
			}
		});
	}
	
	function refreshRightUpData(){
		$.ajax({
			type:'POST',
			url:'<%=path%>/screen/getRightUpAreaData',
			success:function(data){
				if(data<60) {
					$(".network_health").css("color", "red");
					$("#network_health_title").text("网络状态不良");
				} else if(data<80){
					$(".network_health").css("color", "yellow");
					$("#network_health_title").text("网络状态正常");
				} else {
					$(".network_health").css("color", "#6f0");
					$("#network_health_title").text("网络状态健康");
				}
				$("#network_health_value").text(data);
			}
		});
	}
	
	function refreshLeftDownData(){
		$.ajax({
			type:'POST',
			url:'<%=path%>/screen/getLeftDownAreaData',
			success:function(data){
				if(data != null) {
					for(var i=0;i<data.length;i++) {
						var exportStreamInfo = data[i];
						var percent = (exportStreamInfo.downStream * 100)/exportStreamInfo.maxBandWidth;
						var downStreamView = "";
						var upStreamView = "";
						if(exportStreamInfo.downStream/(1024*1024*1024)>1){
							downStreamView = (exportStreamInfo.downStream/(1024*1024*1024)).toFixed(1) + "gb/s";
						} else if(exportStreamInfo.downStream/(1024*1024)>1){
							downStreamView = (exportStreamInfo.downStream/(1024*1024)).toFixed(1) + "mb/s";
						} else if(exportStreamInfo.downStream/(1024)>1){
							downStreamView = (exportStreamInfo.downStream/(1024)).toFixed(1) + "kb/s";
						} else{
							downStreamView = (exportStreamInfo.downStream.toFixed(1)) + "b/s";
						} 
						if(exportStreamInfo.upStream/(1024*1024*1024)>1){
							upStreamView = (exportStreamInfo.upStream/(1024*1024*1024)).toFixed(1) + "gb/s";
						} else if(exportStreamInfo.upStream/(1024*1024)>1){
							upStreamView = (exportStreamInfo.upStream/(1024*1024)).toFixed(1) + "mb/s";
						} else if(exportStreamInfo.upStream/(1024)>1){
							upStreamView = (exportStreamInfo.upStream/(1024)).toFixed(1) + "kb/s";
						} else{
							upStreamView = (exportStreamInfo.upStream.toFixed(1)) + "b/s";
						} 
						$("p[down][_id='"+exportStreamInfo.divId+"']").text(downStreamView);
						$("p[up][_id='"+exportStreamInfo.divId+"']").text(upStreamView);
						
						drawLeftDownCircle(exportStreamInfo.divId, percent);
						drawLeftDownChart(exportStreamInfo.divId, exportStreamInfo.graph);
					}
				}
			}
		});
	}
	
	function refreshRightDownData(){
		$.ajax({
			type:'POST',
			url:'<%=path%>/screen/getRightDownAreaData',
			success:function(data){
				if(data != null) {
					var urlRankingList = data.urlRankingData.urlRankingList;
					var urlTotal = data.urlRankingData.total;
					var html = '';
					for(var i=0;i<urlRankingList.length;i++){
						var urlRanking = urlRankingList[i];
						var percent = ((urlRanking.count * 100)/urlTotal).toFixed(2);
						html += '<li>';
						html += '<div class="zlogdata_url">'+urlRanking.url+'</div>';
						html += '<div class="zlogdata_num">'+percent+' %</div>';
						html += '<div class="data_img_box">';
						html += '<div class="percentage_box warn_' + (i+1)+'" style="width:'+percent+'%;"></div>';
						html += '</div>';
						html += '</li>';
					}
					$("#zlog_data_list").empty();
					$(html).appendTo($("#zlog_data_list"));
					drawRightDownPie("url_ranking", data.urlRankingData);
					drawRightDownSystemStatusChart("zlog_cpu", "cpu", data.systemStatusData, data.systemStatusXaxis);
					drawRightDownSystemStatusChart("zlog_mem", "mem", data.systemStatusData, data.systemStatusXaxis);
					drawRightDownLogCountChart("zlog_log_count", data);
				}
			}
		});
	}
</script>
</head>
<body>
	<div>
		<!-- 头部菜单 start-->
		<%@ include file="../common/header.jsp"%>
		<%@ include file="../common/leftMenu.jsp"%>
		<div class="screen_grid">
			<div>
				<div>
					<div>
						<div class="R" onclick="javascript:showFullScreen();">
							<img src="<%=path%>/images/fullimg.png">
						</div>
						<div style="">
							<img src="<%=path%>/images/preview.png" style="max-height:500px;max-width:100%;"/>
						</div>
					</div>
				</div>
				<div>
					<div>
						<div class="R">
							<img src="<%=path%>/images/fullimg.png">
						</div>
					</div>
				</div>
			</div>
			<div>
				<div>
					<div>
						<div class="R">
							<img src="<%=path%>/images/fullimg.png">
						</div>
					</div>
				</div>
				<div>
					<div>
						<div class="R">
							<img src="<%=path%>/images/fullimg.png">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="full_screen">
		<div class="prj_logo">
				<img src="<%=path%>/images/logo.png" style="width="327" height="56""/>
		</div>
		<div class="prj_top">
			<div class="online_box">
				<div class="online_turntabl_box">
					<h1>在线数</h1>
					<p class="led_fonts js-odoo">
						<script src="<%=path%>/js/vendor/odoo.js"></script>
						<script>odoo.default({ el:'.js-odoo',value:'${leftUp.totalOnlineUserCount}' })</script>
					</p>
					<div class="online_turntable_1"></div>
				</div>
				<ul class="online_people">
					<li>
						<div id="registerUserCount" style="width: 110px; height: 160px;"></div>
						<div class="numbe_a">注册人数</div>
					</li>
					<li>
						<div id="activeUserCount" style="width: 110px; height: 160px;"></div>
						<div class="active_b">活跃人数</div>
					</li>
					<li>
						<div id="freeUserCount" style="width: 110px; height: 160px;"></div>
						<div class="free_c">免费人数</div>
					</li>
					<li>
						<div id="lostUserCount" style="width: 110px; height: 160px;"></div>
						<div class="scour_d">流失人数</div>
					</li>
				</ul>
				<ul class="online_devices">
					<li class="mobile_devices">
						<i></i>移动设备 
						<span id="wireless_count">
							<fmt:formatNumber type="number" value="${leftUp.wirelessUserCount * 100/leftUp.totalOnlineUserCount}" maxFractionDigits="2" />%
						 </span>
					 </li>
					<li class="wired_devices">
						<i></i>有线设备
						<span id="wire_count">
							<fmt:formatNumber type="number" value="${leftUp.wireUserCount * 100/leftUp.totalOnlineUserCount}" maxFractionDigits="2" />%
						</span>
					</li>
					<li class="other_devices">
						<i></i>其他设备 
						<span id="etc_count">
							<fmt:formatNumber type="number" value="${leftUp.etcUserCount * 100/leftUp.totalOnlineUserCount}" maxFractionDigits="2" />%
						</span>
					</li>
				</ul>
			</div>
			<div class="line_box"></div>
	
			<div class="diagram_box" style="height:400px;padding-top:25px !important;">
				<div id="heat_map" style="height:400px;width:600px;">
					<img src="<%=path%>/images/dongbeidaxue.jpg"
						style="width: 100%; height: 100%;">
				</div>
			</div>
			
			<div class="line_box"></div>
			
			<c:choose>
				<c:when test="${rightUp < 60}">
					<div class="network_health" style="color:red">
						<h1 id="network_health_title">网络状态不良</h1>
						<span class="led_fonts" id="network_health_value">${rightUp}</span>
						<div class="network_health_imgbg"></div>
					</div>
				</c:when>
				<c:when test="${rightUp < 80}">
					<div class="network_health" style="color:yellow"> 
						<h1 id="network_health_title">网络状态正常</h1>
						<span class="led_fonts" id="network_health_value">${rightUp}</span>
						<div class="network_health_imgbg"></div>
					</div>
				</c:when>
				<c:otherwise>
					<div class="network_health">
						<h1 id="network_health_title">网络状态健康</h1>
						<span class="led_fonts" id="network_health_value">${rightUp}</span>
						<div class="network_health_imgbg"></div>
					</div>
				</c:otherwise>
			</c:choose>
		</div>
		<div class="line_bottom"></div>
		<div class="prj_bottom">
			<div id="left_down">
				<c:forEach items="${leftDown}" var="exportStreamInfo">
					<dl class="export_utilization">
						<dt>${exportStreamInfo.name}</dt>
						<dd class="scale_diagram_a">
							<div id="${exportStreamInfo.divId}" class="doughnut_container"></div>
						</dd>
						<dd class="traffic_data">
							<ul style="display:table;text-align:center;width:100%;margin-bottom:10px;">
								<li style="display:table-cell;text-align:center;">
									<h2>下行流量</h2>
									<p down _id="${exportStreamInfo.divId}">
										<c:choose>
											<c:when
												test="${exportStreamInfo.downStream/(1024 * 1024 * 1024) >= 1}">
												<fmt:formatNumber type="number"
													value="${exportStreamInfo.downStream/(1024 * 1024 * 1024)}"
													maxFractionDigits="2" minFractionDigits="2"/>gb/s
											</c:when>
											<c:when
												test="${exportStreamInfo.downStream/(1024 * 1024) >= 1}">
												<fmt:formatNumber type="number"
													value="${exportStreamInfo.downStream/(1024 * 1024)}"
													maxFractionDigits="2" minFractionDigits="2"/>mb/s
											</c:when>
											<c:when test="${exportStreamInfo.downStream/(1024) >= 1}">
												<fmt:formatNumber type="number"
													value="${exportStreamInfo.downStream/(1024)}"
													maxFractionDigits="2" minFractionDigits="2"/>kb/s
											</c:when>
											<c:otherwise>
												${exportStreamInfo.downStream}b/s
											</c:otherwise>
										</c:choose>
									</p>
								</li>
								<li style="display:table-cell;text-align:center;">
									<h2>上行流量</h2>
									<p up _id="${exportStreamInfo.divId }">
										<c:choose>
											<c:when
												test="${exportStreamInfo.upStream/(1024 * 1024 * 1024) >= 1}">
												<fmt:formatNumber type="number"
													value="${exportStreamInfo.upStream/(1024 * 1024 * 1024)}"
													maxFractionDigits="2" minFractionDigits="2"/>gb/s
											</c:when>
											<c:when test="${exportStreamInfo.upStream/(1024 * 1024) >= 1}">
												<fmt:formatNumber type="number"
													value="${exportStreamInfo.upStream/(1024 * 1024)}"
													maxFractionDigits="2" minFractionDigits="2"/>mb/s
											</c:when>
											<c:when test="${exportStreamInfo.upStream/(1024) >= 1}">
												<fmt:formatNumber type="number"
													value="${exportStreamInfo.upStream/(1024)}"
													maxFractionDigits="2" minFractionDigits="2"/>kb/s
											</c:when>
											<c:otherwise>
												${exportStreamInfo.upStream}b/s
											</c:otherwise>
										</c:choose>
									</p>
								</li>
							</ul>
						</dd>
						<dd class="scale_diagram_b">
							<div name="${exportStreamInfo.divId}" style="height: 128px;width:300px;"></div>
						</dd>
					</dl>
				</c:forEach>
			</div>
			<!-- 		<div class="line_box"></div> -->
	
			<div class="zlog_box">
				<h1>上网数据分析</h1>
				<div class="zlog_data_a" id="url_ranking">
				</div>
				<ul class="zlog_data_list" id="zlog_data_list">
					<c:forEach items="${rightDown.urlRankingData.urlRankingList}" var="urlRanking"
						varStatus="status">
						<li>
							<div class="zlogdata_url">${urlRanking.url}</div>
							<div class="zlogdata_num">
								<fmt:formatNumber type="number"
									value="${(urlRanking.count * 10000 )/(rightDown.urlRankingData.total * 100)}"
									maxFractionDigits="2" minFractionDigits="2"/>
								%
							</div>
							<div class="data_img_box">
								<div class="percentage_box warn_${status.index+1}"
									style="width: <fmt:formatNumber type="number"
									value="${(urlRanking.count * 10000 )/(rightDown.urlRankingData.total * 100)}"
									maxFractionDigits="2" />%;"></div>
							</div>
						</li>
					</c:forEach>
				</ul>
				<ul class="zlog_data_b">
					<li>
						<div id="zlog_cpu" style="height: 128px;width:180px;"></div>
					</li>
					<li>
						<div id="zlog_mem" style="height: 128px;width:180px;"></div>
					</li>
					<li>
						<div id="zlog_log_count" style="height: 128px;width:180px;"></div>
					</li>
				</ul>
			</div>
	
		</div>
	
		<div class="line_bottom"></div>
	
		<div class="content-container-fluid">
			<div class="row">
				<div class="cols-sample-area">
					<div id="container"></div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
